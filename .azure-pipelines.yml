trigger:
  branches:
    include:
      - master
  tags:
    include:
      - v*
variables:
  isReleaseBuild: $[contains(variables['Build.SourceBranch'], 'tags')]
jobs:
  - job: Linux
    pool:
      vmImage: "ubuntu-16.04"
    variables:
      target: "x86_64-unknown-linux-gnu"
    steps:
      - template: .build-steps.yml
        parameters:
          target: $(target)
          executableName: "texlab"
          archiveFile: "texlab-x86_64-linux.tar.gz"
          archiveType: "tar"
          coverage: true
      - bash: |
          cargo install cargo-deb
          cargo deb --target=$(target)
          mv target/$(target)/debian/texlab* target/$(target)/debian/texlab-x86_64-debian.deb
        condition: and(succeeded(), eq(variables['isReleaseBuild'], 'true'))
        displayName: "Build Debian package"
      - publish: target/$(target)/debian
        artifact: texlab-x86_64-debian.deb
        condition: and(succeeded(), eq(variables['isReleaseBuild'], 'true'))
        displayName: "Publish Debian artifact"
      - bash: |
          cargo install cargo-rpm
          cargo rpm build -v
          mv target/release/rpmbuild/RPMS/x86_64/texlab* target/release/rpmbuild/RPMS/x86_64/texlab-x86_64-rhel.rpm
        condition: and(succeeded(), eq(variables['isReleaseBuild'], 'true'))
        displayName: "Build RHEL package"
      - publish: target/release/rpmbuild/RPMS/x86_64
        artifact: texlab-x86_64-rhel.rpm
        condition: and(succeeded(), eq(variables['isReleaseBuild'], 'true'))
        displayName: "Publish RHEL artifact"
  - job: Windows
    pool:
      vmImage: "vs2017-win2016"
    steps:
      - template: .build-steps.yml
        parameters:
          target: "x86_64-pc-windows-msvc"
          executableName: "texlab.exe"
          archiveFile: "texlab-x86_64-windows.zip"
          archiveType: "zip"
  - job: macOS
    pool:
      vmImage: "macos-10.14"
    steps:
      - bash: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path --default-toolchain none
          echo "##vso[task.prependpath]$HOME/.cargo/bin"
        displayName: "Install rustup"
      - template: .build-steps.yml
        parameters:
          target: "x86_64-apple-darwin"
          executableName: "texlab"
          archiveFile: "texlab-x86_64-macos.tar.gz"
          archiveType: "tar"
  - job: Publish
    dependsOn:
      - Linux
      - Windows
      - macOS
    condition: |
      and(
        eq(variables['isReleaseBuild'], 'true'),
        succeeded('Linux'), 
        succeeded('Windows'), 
        succeeded('macOS'))
    steps:
      - download: current
        patterns: "**/texlab*"
      - task: GitHubRelease@0
        inputs:
          gitHubConnection: latex-lsp
          repositoryName: latex-lsp/texlab
          assets: "$(Pipeline.Workspace)/**/texlab*"
        displayName: "Create GitHub release"
